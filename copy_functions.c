#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <errno.h>
#include <string.h>
#include "copy_functions.h"

int copy(char *src, char *dst, unsigned int buf_size) {
    int fd_src, fd_dst;
    char *buffer;
    int bytes_read, bytes_written;
    int total_bytes = 0;

    // Allocate buffer
    buffer = malloc(buf_size);
    if (buffer == NULL) {
        fprintf(stderr, "Error allocating buffer: %s\n", strerror(errno));
        return -1;
    }

    // Open source file
    fd_src = open(src, O_RDONLY);
    if (fd_src == -1) {
        fprintf(stderr, "Error opening source file: %s\n", strerror(errno));
        free(buffer);
        return -1;
    }

    // Open destination file (create if doesn't exist, truncate if exists)
    fd_dst = open(dst, O_WRONLY | O_CREAT | O_TRUNC, 0644);
    if (fd_dst == -1) {
        fprintf(stderr, "Error opening destination file: %s\n", strerror(errno));
        close(fd_src);
        free(buffer);
        return -1;
    }

    // Copy data in chunks
    while ((bytes_read = read(fd_src, buffer, buf_size)) > 0) {
        bytes_written = write(fd_dst, buffer, bytes_read);
        if (bytes_written != bytes_read) {
            fprintf(stderr, "Error writing to destination file: %s\n", strerror(errno));
            close(fd_src);
            close(fd_dst);
            free(buffer);
            return -1;
        }
        total_bytes += bytes_written;
    }

    // Check for read error
    if (bytes_read == -1) {
        fprintf(stderr, "Error reading from source file: %s\n", strerror(errno));
        total_bytes = -1;
    }

    // Clean up
    close(fd_src);
    close(fd_dst);
    free(buffer);

    return total_bytes;
}

int copyf(char *src, char *dst, unsigned int buf_size) {
    FILE *fp_src, *fp_dst;
    char *buffer;
    size_t bytes_read;
    int total_bytes = 0;

    // Allocate buffer
    buffer = malloc(buf_size);
    if (buffer == NULL) {
        fprintf(stderr, "Error allocating buffer: %s\n", strerror(errno));
        return -1;
    }

    // Open source file
    fp_src = fopen(src, "rb");
    if (fp_src == NULL) {
        fprintf(stderr, "Error opening source file: %s\n", strerror(errno));
        free(buffer);
        return -1;
    }

    // Open destination file
    fp_dst = fopen(dst, "wb");
    if (fp_dst == NULL) {
        fprintf(stderr, "Error opening destination file: %s\n", strerror(errno));
        fclose(fp_src);
        free(buffer);
        return -1;
    }

    // Copy data in chunks
    while ((bytes_read = fread(buffer, 1, buf_size, fp_src)) > 0) {
        if (fwrite(buffer, 1, bytes_read, fp_dst) != bytes_read) {
            fprintf(stderr, "Error writing to destination file: %s\n", strerror(errno));
            fclose(fp_src);
            fclose(fp_dst);
            free(buffer);
            return -1;
        }
        total_bytes += bytes_read;
    }

    // Check for read error
    if (ferror(fp_src)) {
        fprintf(stderr, "Error reading from source file: %s\n", strerror(errno));
        total_bytes = -1;
    }

    // Clean up
    fclose(fp_src);
    fclose(fp_dst);
    free(buffer);

    return total_bytes;
}